<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>ISBN Scanner</title>
  <meta name="description" content="Scan book barcodes with your camera and save them to Google Sheets.">
  <meta name="theme-color" content="#2D6A4F">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ISBN Scanner">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Lato:wght@400;600;700&family=Lora:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css">
</head>
<body>

<!-- ── Header ── -->
<header id="app-header">
  <div class="container header-inner">
    <div class="header-left">
      <span class="app-logo" id="icon-book" aria-hidden="true"></span>
      <div class="dropdown-wrap" id="lib-dropdown-wrap">
        <button id="lib-switcher-btn" aria-haspopup="listbox" aria-label="Switch library">
          <span class="lib-name" id="lib-name">Loading…</span>
          <span id="icon-chevron"></span>
        </button>
        <div class="dropdown hidden" id="lib-dropdown" role="listbox">
          <div class="dropdown-label">Your libraries</div>
          <div class="dropdown-sep"></div>
          <div id="lib-dropdown-list"></div>
          <div class="dropdown-sep"></div>
          <div class="dropdown-add" id="lib-add-btn" role="option" tabindex="0">
            <span id="icon-add-lib"></span>
            Add library…
          </div>
        </div>
      </div>
    </div>
    <div class="header-right">
      <a id="sheet-link" href="#" target="_blank" rel="noopener noreferrer" class="sheet-link hidden" aria-label="Open Google Sheet">
        <span id="icon-external"></span>
        <span>Sheet</span>
      </a>
      <button id="settings-btn" class="icon-btn" aria-label="Open settings">
        <span id="icon-settings"></span>
        <span class="dot hidden" id="settings-dot"></span>
      </button>
    </div>
  </div>
</header>

<!-- ── Main ── -->
<main id="main">
  <div class="container">

    <!-- Status banners -->
    <div class="banner warn hidden" id="banner-no-profile" role="alert">
      <span id="banner-warn-icon"></span>
      <div><strong>No library configured.</strong> Tap the library name above to add one, or
        <button class="link" onclick="openSetupModal()">open settings →</button>
      </div>
    </div>
    <div class="banner warn hidden" id="banner-no-sheet" role="alert">
      <span id="banner-warn2-icon"></span>
      <div><strong>Google Sheet not connected.</strong> Books saved locally only.
        <button class="link" onclick="openSetupModal()">Set up now →</button>
      </div>
    </div>
    <div class="banner ok hidden" id="banner-connected">
      <span id="banner-ok-icon"></span>
      <div>Connected to <strong>"<span id="banner-sheet-name"></span>"</strong>. Books saved automatically.</div>
    </div>

    <!-- ── Scan view ── -->
    <div id="view-scan">

      <section aria-labelledby="scanner-heading">
        <div class="scanner-controls">
          <h2 id="scanner-heading">Barcode Scanner</h2>
          <button id="scanner-start-btn" class="btn btn-primary">
            <span id="icon-camera"></span>
            Start Scanner
          </button>
        </div>

        <!-- Camera feed (hidden until started) -->
        <div id="scanner-wrap" class="hidden" style="position:relative;width:100%;aspect-ratio:4/3;max-height:320px;background:#111;border-radius:8px;overflow:hidden;">
          <video id="scanner-video" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover;display:block;"></video>
          <div class="scanner-overlay">
            <div class="scan-frame">
              <div class="scan-line"></div>
            </div>
          </div>
          <div class="flash-overlay" id="flash-overlay"></div>
        </div>

        <!-- Placeholder when scanner is off -->
        <div id="scanner-placeholder" class="scanner-placeholder">
          <span id="scanner-placeholder-icon" style="color:#9CA3AF;"></span>
          <p>Tap "Start Scanner" to activate your camera</p>
        </div>

        <p id="scan-status" class="scanner-hint hidden"></p>
        <p class="scanner-hint">Point your camera at a book's barcode. ISBN-13 and ISBN-10 supported.</p>
      </section>

      <section aria-labelledby="manual-heading">
        <h2 id="manual-heading">Manual Entry</h2>
        <div class="manual-row">
          <input type="text" id="manual-input" inputmode="numeric" placeholder="Enter ISBN (10 or 13 digits)" aria-label="Manual ISBN entry">
          <button id="manual-lookup-btn" class="btn btn-primary" style="flex-shrink:0;white-space:nowrap;">
            <span id="icon-look-up"></span>Look Up
          </button>
        </div>
      </section>

      <div class="divider"></div>

      <section aria-labelledby="library-heading">
        <div class="list-header">
          <div style="display:flex;align-items:center;">
            <h2 id="library-heading">Scanned Books</h2>
            <span class="badge hidden" id="book-count-badge">0</span>
          </div>
          <button id="clear-all-btn" class="btn btn-ghost hidden" style="font-size:.8rem;color:#6B7280;">
            Clear all
          </button>
        </div>

        <div id="book-list-empty" class="empty-state">
          <span id="empty-icon"></span>
          <p>No books scanned yet.</p>
          <p>Start the scanner above or enter an ISBN manually.</p>
        </div>

        <div id="book-list" role="list" aria-label="Scanned books"></div>
      </section>
    </div><!-- /view-scan -->

    <!-- ── Shelf view ── -->
    <div id="view-shelf" class="hidden">
      <section aria-labelledby="shelf-heading">
        <div class="list-header">
          <div style="display:flex;align-items:center;">
            <h2 id="shelf-heading">
              <span id="shelf-heading-name">My Bookshelf</span>
            </h2>
            <span class="badge hidden" id="shelf-count-badge">0</span>
          </div>
        </div>

        <div id="shelf-search">
          <div style="position:relative;">
            <span id="icon-search" style="position:absolute;left:.65rem;top:50%;transform:translateY(-50%);color:#9CA3AF;pointer-events:none;"></span>
            <input type="search" id="shelf-search-input" placeholder="Search by title, author or ISBN…" style="padding-left:2.2rem;" aria-label="Search bookshelf">
          </div>
        </div>

        <div id="shelf-rows"></div>
        <p id="shelf-footer" class="shelf-footer"></p>
      </section>
    </div><!-- /view-shelf -->

  </div><!-- /container -->
</main>

<!-- ── Footer ── -->
<footer id="app-footer">
  <div class="container">
    Book data from <a href="https://books.google.com" target="_blank" rel="noopener noreferrer">Google Books</a>
    &amp; <a href="https://openlibrary.org" target="_blank" rel="noopener noreferrer">Open Library</a>
  </div>
</footer>

<!-- ── Bottom tab bar ── -->
<nav id="tab-bar" aria-label="Main navigation">
  <button id="tab-scan" class="tab-btn active" aria-label="Scan view">
    <span id="icon-scan-tab"></span>
    <span>Scan</span>
  </button>
  <button id="tab-shelf" class="tab-btn" aria-label="Bookshelf view">
    <span id="icon-shelf-tab"></span>
    <span>Bookshelf</span>
    <span class="tab-badge hidden" id="shelf-badge"></span>
  </button>
</nav>

<!-- ── Setup / Settings modal ── -->
<div class="modal-backdrop hidden" id="setup-modal" role="dialog" aria-modal="true" aria-labelledby="setup-modal-title">
  <div class="modal">
    <div class="modal-header">
      <h3 id="setup-modal-title">Settings</h3>
      <button class="icon-btn" aria-label="Close settings"><span id="icon-close-setup"></span></button>
    </div>
    <div class="modal-body">
      <div class="modal-tabs">
        <button class="modal-tab active" id="setup-tab-guide">Setup Guide</button>
        <button class="modal-tab" id="setup-tab-connection">Connection</button>
      </div>

      <!-- Guide pane -->
      <div id="setup-pane-guide">
        <p style="font-size:.875rem;margin-bottom:1rem;color:#374151;">
          To sync scanned books to a Google Sheet, deploy a small Apps Script web app in your spreadsheet. Follow these steps:
        </p>
        <ol class="setup-steps">
          <li>Open (or create) your Google Spreadsheet and go to <strong>Extensions → Apps Script</strong>.</li>
          <li>Delete any existing code and paste the code below into the editor.</li>
          <li>Click <strong>Deploy → New deployment</strong>. Choose type <em>Web app</em>, set <em>Execute as: Me</em> and <em>Who has access: Anyone</em>.</li>
          <li>Click <strong>Deploy</strong>, authorise the app, then copy the <em>Web app URL</em>.</li>
          <li>Paste that URL into the <strong>Connection</strong> tab and save.</li>
        </ol>

        <div class="code-block" style="margin-top:1.25rem;">
          <div class="code-block-header">
            <span>google-apps-script</span>
            <button class="btn btn-ghost" style="font-size:.75rem;padding:.2rem .6rem;gap:.3rem;" onclick="copyCode()">
              <span id="icon-copy-code"></span> Copy Code
            </button>
          </div>
          <pre id="apps-script-code">function doGet(e) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheetName = e.parameter.sheetName || 'Books';
    var sheet = ss.getSheetByName(sheetName)
                || ss.insertSheet(sheetName);

    // Add header row if empty
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        'ISBN','Title','Authors','Publisher',
        'Published','Pages','Categories','Scanned At'
      ]);
    }

    sheet.appendRow([
      e.parameter.isbn        || '',
      e.parameter.title       || '',
      e.parameter.authors     || '',
      e.parameter.publisher   || '',
      e.parameter.publishedDate || '',
      e.parameter.pageCount   || '',
      e.parameter.categories  || '',
      e.parameter.scannedAt   || new Date().toISOString()
    ]);

    return ContentService
      .createTextOutput(JSON.stringify({status:'ok'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService
      .createTextOutput(JSON.stringify({status:'error',message:err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}</pre>
        </div>
      </div><!-- /guide pane -->

      <!-- Connection pane -->
      <div id="setup-pane-connection" class="hidden">
        <div class="field">
          <label for="setup-sheet-name">Sheet tab name</label>
          <input type="text" id="setup-sheet-name" placeholder="Books">
          <p class="hint">The name of the tab inside your spreadsheet (default: Books).</p>
        </div>
        <div class="field">
          <label for="setup-script-url">Apps Script Web App URL</label>
          <input type="url" id="setup-script-url" placeholder="https://script.google.com/macros/s/…" style="font-family:var(--font-mono);font-size:.8rem;">
          <p class="hint">Paste the deployment URL from step 4 of the Setup Guide.</p>
        </div>
        <div class="field">
          <label for="setup-spreadsheet-url">Spreadsheet URL <span style="font-weight:400;color:#6B7280;">(optional)</span></label>
          <input type="url" id="setup-spreadsheet-url" placeholder="https://docs.google.com/spreadsheets/…" style="font-family:var(--font-mono);font-size:.8rem;">
          <p class="hint">Used to add a quick-access link in the header.</p>
        </div>
      </div><!-- /connection pane -->
    </div>
    <div class="modal-footer" id="setup-modal-footer-connection" style="display:none;">
      <button class="btn btn-outline" onclick="document.getElementById('setup-modal').classList.add('hidden')">Cancel</button>
      <button class="btn btn-primary" id="setup-save-btn">Save</button>
    </div>
    <div class="modal-footer" id="setup-modal-footer-guide">
      <button class="btn btn-primary" onclick="switchSetupTab('connection');document.getElementById('setup-modal-footer-guide').style.display='none';document.getElementById('setup-modal-footer-connection').style.display='flex';">
        Next: Enter URL →
      </button>
    </div>
  </div>
</div>

<!-- ── Add / Edit Library modal ── -->
<div class="modal-backdrop hidden" id="profile-modal" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title">
  <div class="modal">
    <div class="modal-header">
      <h3 id="profile-modal-title">Add Library</h3>
      <button class="icon-btn" aria-label="Close"><span id="icon-close-profile"></span></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="profile-modal-id">
      <div class="field">
        <label for="profile-name">Library name</label>
        <input type="text" id="profile-name" placeholder="e.g. Home Library, Office Books…">
      </div>
      <div class="field">
        <label for="profile-sheet-name">Sheet tab name</label>
        <input type="text" id="profile-sheet-name" placeholder="Books">
      </div>
      <div class="field">
        <label for="profile-script-url">Apps Script URL</label>
        <input type="url" id="profile-script-url" placeholder="https://script.google.com/macros/s/…" style="font-family:var(--font-mono);font-size:.8rem;">
        <p class="hint">See the Setup Guide in settings for instructions.</p>
      </div>
      <div class="field">
        <label for="profile-spreadsheet-url">Spreadsheet URL <span style="font-weight:400;color:#6B7280;">(optional)</span></label>
        <input type="url" id="profile-spreadsheet-url" placeholder="https://docs.google.com/spreadsheets/…" style="font-family:var(--font-mono);font-size:.8rem;">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="profile-cancel-btn">Cancel</button>
      <button class="btn btn-primary" id="profile-save-btn">Save</button>
    </div>
  </div>
</div>

<!-- ZXing barcode library via CDN -->
<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script src="app.js"></script>

<script>
  // Wire up the setup modal footer toggle when switching tabs
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('setup-tab-guide').addEventListener('click', () => {
      document.getElementById('setup-modal-footer-guide').style.display = 'flex';
      document.getElementById('setup-modal-footer-connection').style.display = 'none';
    });
    document.getElementById('setup-tab-connection').addEventListener('click', () => {
      document.getElementById('setup-modal-footer-guide').style.display = 'none';
      document.getElementById('setup-modal-footer-connection').style.display = 'flex';
    });
    // Also wire the scanner start button icon
    const btn = document.getElementById('scanner-start-btn');
    const iconSpan = btn.querySelector('span');
    iconSpan.id = 'icon-camera';
    // The icon is injected by app.js after DOMContentLoaded; re-inject here as fallback
  });
</script>

</body>
</html>
